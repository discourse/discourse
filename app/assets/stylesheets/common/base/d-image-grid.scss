.d-image-grid:not([data-disabled]) {
  $grid-column-gap: 6px;

  &[data-columns] {
    display: flex;
    flex-wrap: wrap;
  }

  &[data-columns="2"] > * {
    flex-basis: calc(50% - ($grid-column-gap / 2));
    margin-right: $grid-column-gap;
  }

  &[data-columns="3"] > * {
    flex-basis: calc(33.33% - ($grid-column-gap * 0.667));
    margin-right: $grid-column-gap;
  }

  .d-image-grid-column {
    box-sizing: border-box;

    // use flex layout, flex-grow and object-fit: cover
    // to better have the images fill their containers
    // and line up vertically (it's not perfect!)
    display: flex;
    flex-direction: column;
    justify-content: flex-start;

    .button-wrapper {
      bottom: 0;
      min-width: unset;
    }

    > div,
    > span {
      flex-grow: 1;
      overflow: hidden;

      // hardcoded max-height here prevents extra tall images
      // from having an outsized effect on the grid
      max-height: 1200px;

      img:not(.thumbnail, .ytp-thumbnail-image, .emoji) {
        height: 100%;
        object-fit: cover;
      }
    }

    &:last-child {
      margin-right: 0;
    }

    > img,
    > div {
      margin-bottom: $grid-column-gap;
    }

    // Forces images in the grid to fill each column width-wise
    img,
    > .lightbox-wrapper,
    > .lightbox-wrapper > .lightbox {
      width: 100%;
    }

    .lightbox-wrapper {
      .meta .informations {
        display: none;
      }

      .meta .filename {
        flex-grow: 3;
      }

      // full-height lightbox element in container
      > .lightbox {
        height: 100%;
      }
    }

    // when staging edits
    .image-wrapper {
      display: block;
      margin-bottom: $grid-column-gap;
      padding-bottom: 0;
    }
  }

  .d-editor-preview & {
    .image-wrapper {
      margin-bottom: $grid-column-gap;
      padding-bottom: 0;

      .button-wrapper {
        .scale-btn-container,
        &[editing] .wrap-image-grid-button {
          display: none;
        }
      }
    }
  }
}

.d-image-grid--carousel {
  position: relative;
  width: 100%;

  .d-image-grid__carousel {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .d-image-grid__track {
    display: flex;
    width: 100%;
    height: 400px;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    border-radius: var(--d-border-radius);
  }

  .d-image-grid__carousel--focus {
    .d-image-grid__slide {
      flex: 0 0 100%;
      width: 100%;
    }
  }

  .d-image-grid__carousel--stage {
    .d-image-grid__track {
      padding-inline: 8%; // Balanced padding for peeking
      box-sizing: border-box;
      gap: 10px; // Explicit 10px gap as requested
    }

    .d-image-grid__slide {
      flex: 0 0 auto;
      width: auto;
      max-width: 84%;
      transition:
        transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
        opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
        filter 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0.8;
      transform: scale(0.95);
      filter: brightness(0.9) saturate(0.9);
      will-change: transform, opacity, filter;

      &.is-active {
        opacity: 1;
        transform: scale(1);
        filter: none;

        img {
          box-shadow: 0 4px 12px rgb(var(--always-black-rgb) / 0.15);
        }
      }
    }
  }

  .d-image-grid__track::-webkit-scrollbar {
    display: none;
  }

  .d-image-grid__slide {
    flex: 0 0 100%;
    height: 100%;
    scroll-snap-align: center;
    scroll-snap-stop: always;
    display: flex;
    align-items: center;
    justify-content: center;

    img:not(.thumbnail, .ytp-thumbnail-image, .emoji) {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: var(--d-border-radius);
      transition: box-shadow 0.4s ease;
    }
  }

  .lightbox-wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    max-width: 100%;
    max-height: 100%;
    height: 100%;

    // Ensure the lightbox link itself doesn't force a crop
    .lightbox {
      display: flex;
      align-items: center;
      justify-content: center;
      max-width: 100%;
      max-height: 100%;
      height: 100%;
    }
  }

  .d-image-grid__controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding-block: var(--space-2);
  }

  .d-image-grid__nav {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border: 0;
    border-radius: 999px;
    padding: 0;
    background: var(--primary-low);
    color: var(--primary-medium);
    cursor: pointer;
    transition:
      background-color 0.2s ease-in-out,
      color 0.2s ease-in-out;

    &:hover {
      background: var(--primary-low-mid);
      color: var(--primary);
    }

    &:disabled {
      cursor: default;
      opacity: 0.3;
    }

    svg {
      font-size: var(--font-down-1);
    }
  }

  .d-image-grid__dots {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: var(--primary-very-low);
    border-radius: 1rem;
    border: 1px solid var(--primary-low);
  }

  .d-image-grid__dot {
    height: 0.6rem;
    width: 0.6rem;
    padding: 0;
    background: var(--primary-low-mid);
    border: none;
    border-radius: 1rem;
    cursor: pointer;
    transition:
      width 0.25s cubic-bezier(0.4, 0, 0.2, 1),
      background-color 0.25s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.15s ease-out;

    &:hover {
      transform: scale(1.2);
    }

    &.active {
      background: var(--primary-medium);
      width: 1.4rem;
    }
  }

  .d-image-grid__carousel--single {
    .d-image-grid__controls {
      display: none;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .d-image-grid__track {
      scroll-behavior: auto;
    }
  }
}
