<%# locals: (opts:) %>

<%- Discourse.find_plugin_js_assets(opts).tap do |plugin_assets| %>
  <%- plugin_assets.each do |asset| %>
    <%if asset[:type_module] %>
      <link rel="modulepreload" href="<%= script_asset_path(asset[:name]) %>" nonce="<%= csp_nonce_placeholder %>" data-plugin-name="<%= asset[:plugin].directory_name %>">
    <% else %>
      <%= preload_script asset[:name] %>
    <% end %>  
  <%- end %>
  <script type="importmap" nonce="<%= csp_nonce_placeholder %>">
    <%=
      {
        imports: plugin_assets.filter_map{ |a| [a[:importmap_name], script_asset_path(a[:name])] if a[:importmap_name] }.to_h
      }.to_json.html_safe
    %>
  </script>
<%- end %>
