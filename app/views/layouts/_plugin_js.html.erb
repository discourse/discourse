<%# locals: (opts:) %>

<%- Discourse.find_plugin_js_assets(opts).tap do |plugin_assets| %>
  <script type="importmap" nonce="<%= csp_nonce_placeholder %>">
    <%= generate_import_map(plugin_assets) %>
  </script>

  <%- plugin_assets.each do |asset| %>
    <% if asset[:type_module] %>
      <link rel="modulepreload" href="<%= script_asset_path(asset[:name]) %>" nonce="<%= csp_nonce_placeholder %>" data-plugin-name="<%= asset[:plugin].directory_name %>">
    <% else %>
      <%= preload_script asset[:name] %>
    <% end %>

    <%= preload_script asset[:name], attrs: {
          "data-discourse-plugin": asset[:plugin].metadata.name,
          "data-official": asset[:plugin].metadata.official?,
          "data-preinstalled": asset[:plugin].preinstalled?,
        } %>
  <%- end %>

  <%- plugin_assets.flat_map { it[:imports] }.compact.uniq.each do |import| %>
    <link rel="modulepreload" href="<%= script_asset_path(import) %>" nonce="<%= csp_nonce_placeholder %>">
  <%- end %>
<%- end %>
